name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Run tests directly on the VM (faster, good for quick feedback)
  test-on-vm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v1

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run API Server & Tests
        # Start the server in the background then run tests.
        # YAML treats multiple lines after pipe '|' as a string, with line separators preserved.
        # The string will be fed to the shell on the virtual machine.
        run: |  
          uv run uvicorn src.todo_app:app --port 8000 &
          sleep 3
          uv run pytest --maxfail=1 --verbose

  # Job 2: Run tests using Docker Compose (ensures environment consistency)
  test-using-docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run tests with Docker Compose
        # --abort-on-container-exit: Stops all containers when the test container finishes.
        # --exit-code-from tester: Returns the exit code of the 'tester' service (pass/fail).
        run: docker compose up --build --abort-on-container-exit --exit-code-from tester